{% extends "dashboard_base.html" %}
{% block title %}Breathe | Access Restricted{% endblock %}

{% block content %}
<section class="bg-backgrounds-50 py-8 antialiased dark:bg-gray-900 md:py-16 min-w-full">
    <div class="mx-auto max-w-screen-6xl px-4 2xl:px-0">
        <div class="mx-auto max-w-6xl">
            <div class="max-w-4xl mx-auto text-center p-6 bg-white shadow-md rounded">
                <h2 class="text-2xl font-bold text-red-600">Access Restricted</h2>
                <p class="text-gray-700 mt-4">You need to purchase access to view content.</p>

                <div class="my-6 space-y-4">
                    <!-- IntaSend M-PESA Button -->
                    {% comment %} <button
                        data-method="M-PESA"
                        data-amount="200"
                        data-currency="KES"
                        class="intaSendPayButton bg-btns-500 hover:bg-btns-600 text-white px-4 py-2 rounded"
                    >
                        Purchase Access (M-PESA)
                    </button> {% endcomment %}
                    <button data-modal-target="mpesa-modal" data-modal-toggle="mpesa-modal"
                        class="text-white bg-btns-700 hover:bg-btns-800 font-medium rounded-lg text-sm px-5 py-2.5">
                        Pay with M-Pesa
                    </button>
            </div>
        </div>
    </div>
</section>
<div id="mpesa-modal" tabindex="-1" aria-hidden="true"
  class="hidden fixed top-0 left-0 right-0 z-50 flex justify-center items-center w-full h-screen bg-black/50">
  <div class="relative bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full">
    <!-- Modal header -->
    <div class="flex items-start justify-between border-b rounded-t dark:border-gray-600 border-gray-200">
        <div class="flex flex-col">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                Initiate M-Pesa Payment
            </h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Enter your phone number to continue.</p>
        </div>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="mpesa-modal">
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">Close modal</span>
        </button>
    </div>
    

    <form id="mpesa-payment-form">
      <input type="tel" id="phone" name="phone" required maxlength="13" placeholder="2547XXXXXXXX"
        class="w-full px-4 py-2 mb-3 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-btns-500" />
      <button type="submit"
        class="w-full bg-btns-600 hover:bg-btns-700 text-white font-medium py-2 rounded-lg text-sm">
        Pay KES 200
      </button>
    </form>

    <div id="payment-error" class="text-red-500 text-sm mt-3 hidden"></div>
  </div>
</div>
<div id="success-modal" class="hidden fixed top-0 left-0 right-0 z-50 flex justify-center items-center w-full h-screen bg-black/50">
  <div class="relative bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full text-center">
    <h3 class="text-lg font-bold text-green-600 mb-2">Payment Successful</h3>
    <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">Redirecting to dashboard...</p>
  </div>
</div>
<div id="failure-modal" class="hidden fixed top-0 left-0 right-0 z-50 flex justify-center items-center w-full h-screen bg-black/50">
  <div class="relative bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full text-center">
    <h3 class="text-lg font-bold text-red-600 mb-2">Payment Failed</h3>
    <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">Something went wrong. Try again.</p>
    <button id="close-failure-modal" data-modal-hide="failure-modal"
      class="text-sm text-btns-600 hover:underline mt-2">Close</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/datepicker.min.js"></script>
<script src="https://unpkg.com/intasend-inlinejs-sdk@3.0.1/build/intasend-inline.js"></script>
<script>
    new window.IntaSend({
        publicAPIKey: "ISPubKey_live_df220f3d-4531-4b00-8487-4379e6ee0d7c",
        live: true
    })
    .on("COMPLETE", (results) => {
        console.log("Payment success:", results);
        window.location.href = "{% url 'transaction_list' %}";
    })
    .on("FAILED", (results) => {
        console.error("Payment failed:", results);
    })
    .on("IN-PROGRESS", (results) => {
        console.log("Payment in progress:", results);
    });
</script>
<script>
  document.getElementById("mpesa-payment-form").addEventListener("submit", function (e) {
    e.preventDefault();

    const phone = document.getElementById("phone").value;
    const errorDiv = document.getElementById("payment-error");
    errorDiv.classList.add("hidden");

    fetch("{% url 'pay' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        phone_number: phone,
        amount: 200,
        account_reference: "BREATH-ACCESS",
        transaction_desc: "12 Hour Access"
      })
    })
    .then(response => {
      if (!response.ok) throw new Error("Network error");
      return response.json();
    })
    .then(data => {
      if (data.status === "success") {
        document.getElementById("mpesa-modal").classList.add("hidden");
        document.getElementById("success-modal").classList.remove("hidden");

        setTimeout(() => {
          window.location.href = "{% url 'dashboard' %}";
        }, 3000);
      } else {
        throw new Error("Payment not successful");
      }
    })
    .catch(error => {
      console.error(error);
      document.getElementById("mpesa-modal").classList.add("hidden");
      document.getElementById("failure-modal").classList.remove("hidden");
    });
  });
</script>
<script>
  document.getElementById("failure-modal").addEventListener("click", function () {
    document.getElementById("failure-modal").classList.add("hidden");
  });
</script>
{% endblock %}
